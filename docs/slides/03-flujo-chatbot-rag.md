# 🤖 Slide 03: Flujo Chatbot RAG

## Retrieval-Augmented Generation - Cómo el Chatbot Responde

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CHATBOT RAG FLOW                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  1. USUARIO ENVÍA PREGUNTA                                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────────┐
                              │  "¿Cuánto cuesta    │
                              │   QRIBAR?"          │
                              └──────────┬──────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. GENERATE EMBEDDING (Gemini)                                            │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────────┐
                    │  text-embedding-004      │
                    │  (768 dimensiones)        │
                    └───────────┬───────────────┘
                                │
                    ┌───────────▼─────────────┐
                    │  Query Embedding        │
                    │  [0.123, -0.456, ...]  │
                    └─────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. CHECK CACHE (Opcional)                                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────┐
                    │   In-Memory Cache      │
                    │   (TTL: 7 días)        │
                    └───────────┬─────────────┘
                                │
                    ┌───────────▼─────────────┐
                    │  HIT? → Return cached   │
                    │  MISS? → Continue       │
                    └─────────────────────────┘
                                │
                          MISS  │
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. VECTOR SEARCH (pgvector)                                              │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────┐
                    │  match_documents()      │
                    │  similarity > 0.7       │
                    │  top_k = 5              │
                    └───────────┬─────────────┘
                                │
          ┌─────────────────────┼─────────────────────┐
          │                     │                     │
          ▼                     ▼                     ▼
   ┌────────────┐        ┌────────────┐        ┌────────────┐
   │ Document 1 │        │ Document 2 │        │ Document 3 │
   │ (QRIBAR)  │        │ (Reviews)  │        │ (Pricing)  │
   │ similarity│        │ similarity │        │ similarity │
   │   0.92    │        │   0.85     │        │   0.78     │
   └────────────┘        └────────────┘        └────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  5. CONTEXT ASSEMBLY                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────┐
                    │  Prompt + Context       │
                    └───────────┬─────────────┘
                                │
          ┌─────────────────────┴─────────────────────┐
          │                                           │
          ▼                                           ▼
   ┌─────────────────────────────────────┐   ┌──────────────┐
   │  SYSTEM PROMPT:                    │   │  USER:       │
   │  Eres asistente de QRIBAR.         │   │  ¿Cuánto     │
   │  Contexto: {documents}             │   │  cuesta?     │
   │  Responde en español.               │   │
   └─────────────────────────────────────┘   └──────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  6. GENERATE RESPONSE (Gemini)                                            │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────────┐
                    │  gemini-2.5-flash         │
                    └───────────┬───────────────┘
                                │
                    ┌───────────▼─────────────┐
                    │  "QRIBAR cuesta $200   │
                    │   USD. Incluye código   │
                    │   QR y panel admin..."  │
                    └─────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  7. RESPONSE + CACHE                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────────┐
                    │  ← Respuesta al usuario   │
                    │  → Guardar embedding      │
                    │    en cache              │
                    └───────────────────────────┘
```

---

## Arquitectura de Componentes

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FRONTEND (React)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     RAGOrchestrator                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐  │
│  │ InputHandler │─►│RAGIndexer   │─►│VectorSearch  │─►│ GeminiLLM │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘  │
│         │                 │                 │                 │           │
│         ▼                 ▼                 ▼                 ▼           │
│  ┌──────────────────────────────────────────────────────────────────┐    │
│  │                     EMBEDDING CACHE                               │    │
│  │              (In-Memory + Supabase backup)                       │    │
│  └──────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     SUPABASE EDGE FUNCTIONS                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────┐  ┌───────────────────────────────────────────┐ │
│  │  gemini-embedding     │  │  chat-with-rag                           │ │
│  │  - Generate embedding │  │  - Full RAG pipeline                     │ │
│  │  - API key protected  │  │  - Cache integration                    │ │
│  └───────────────────────┘  └───────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     SUPABASE DATABASE                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────┐  ┌───────────────────────────────────────────┐ │
│  │  documents table      │  │  match_documents() function              │ │
│  │  - content (text)     │  │  - Vector similarity search             │ │
│  │  - embedding (vector)│  │  - pgvector index                       │ │
│  │  - metadata (jsonb)  │  │  - Threshold filtering                 │ │
│  └───────────────────────┘  └───────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Fallback Strategy

```
                    ┌──────────────────┐
                    │  User Query      │
                    └────────┬─────────┘
                             │
                             ▼
                ┌────────────────────────┐
                │  Intent Detection      │
                │  (pricing, features,   │
                │   implementation, etc) │
                └───────────┬────────────┘
                            │
              ┌─────────────┼─────────────┐
              │             │             │
              ▼             ▼             ▼
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │ DETECTED │  │ LOW CONF │  │ NO MATCH │
        │  → RAG   │  │ → Fallback│  │ → Fallback│
        └──────────┘  └────┬─────┘  └────┬─────┘
                           │             │
                           ▼             ▼
                    ┌──────────────┐ ┌──────────────┐
                    │ Categorized │ │   Generic    │
                    │  Response   │ │   Response   │
                    └──────────────┘ └──────────────┘
```
